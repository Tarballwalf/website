## Nextcloud Docker Deployment

### Install Docker

Simplest way to install docker on Ubuntu is by using snap (I know we all hate snaps but it's the easiest way)

```
# snap install docker
```

### Install Nextcloud

Before we start defining services in the `docker-compose.yml` file, we create a network so that containers can communicate. Run the following command in the terminal:

```
# docker network create nextcloud_network
```

We’ll define the services one by one, starting with the Nginx reverse proxy:

* Nginx reverse proxy
* Let’s Encrypt
* MariaDB
* Nextcloud

Create the docker compose file where we will define all the services. 

```
# nano docker-compose.yml
```

### Configure the Nginx reverse proxy container

In the `docker-compose.yml` file we just created, paste the following:

```
version: '3'  

services:

  proxy:
    image: jwilder/nginx-proxy:alpine
    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"
    container_name: nextcloud-proxy
    networks:
      - nextcloud_network
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./proxy/conf.d:/etc/nginx/conf.d:rw
      - ./proxy/vhost.d:/etc/nginx/vhost.d:rw
      - ./proxy/html:/usr/share/nginx/html:rw
      - ./proxy/certs:/etc/nginx/certs:ro
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/tmp/docker.sock:ro
    restart: unless-stopped
```

The service for proxy uses the image from [jwilder/nginx-proxy](https://github.com/nginx-proxy/nginx-proxy). The label `com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy` is used so that the Let’s Encrypt container knows which nginx proxy container to use for certificate generation.Then, there is network by the name `nextcloud_network`, which is used by the containers to communicate among themselves. The Volumes section is used by the container to configure the Nginx virtual host and to access certificates generated by Let’s Encrypt companion container. The `/etc/localtime:/etc/localtime:ro` is used to duplicate the host timezone inside the container.

### Configure the Let’s Encrypt container

Now that you have `nginx-proxy` container set up, you can add the following to your docker-compose.yml file. 

```
  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: nextcloud-letsencrypt
    depends_on:
      - proxy
    networks:
      - nextcloud_network
    volumes:
      - ./proxy/certs:/etc/nginx/certs:rw
      - ./proxy/vhost.d:/etc/nginx/vhost.d:rw
      - ./proxy/html:/usr/share/nginx/html:rw
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
```

The Lets’ Encrypt container depends on our first service `(proxy)` and is a part of the network `nextcloud_network`. The restart: `unless-stopped` allows the containers to be stopped gracefully unless you manually run `docker stop letsencrypt` or `docker-compose down letsencrypt`. 

### Configure the MariaDB container

For Nextcloud to work correctly, we need to connect it to a MariaDB database. Fortunately, we can add that to our `docker-compose.yml` file as well: 

```
  db:
    image: mariadb
    container_name: nextcloud-mariadb
    networks:
      - nextcloud_network
    volumes:
      - db:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    environment:
      - MYSQL_ROOT_PASSWORD=secret
      - MYSQL_PASSWORD=mysql
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    restart: unless-stopped
```

The service section for MariaDB is pretty self-explanatory. This container is also part of the network `nextcloud_network`. We have also defined the environment variable for the database name, username, and password that Nextcloud uses to connect to the database. 

### Configure the Nextcloud Docker container

We’re finally ready to create the Nextcloud Docker container in our `docker-compose.yml` file. Add the following to the bottom, but we're not done yet.

```
 app:
    image: nextcloud:latest
    container_name: nextcloud-app
    networks:
      - nextcloud_network
    depends_on:
      - letsencrypt
      - proxy
      - db
    volumes:
      - nextcloud:/var/www/html
      - ./app/config:/var/www/html/config
      - ./app/custom_apps:/var/www/html/custom_apps
      - ./app/data:/var/www/html/data
      - ./app/themes:/var/www/html/themes
      - /etc/localtime:/etc/localtime:ro
    environment:
      - VIRTUAL_HOST=nextcloud.YOUR-DOMAIN
      - LETSENCRYPT_HOST=nextcloud.YOUR-DOMAIN
      - LETSENCRYPT_EMAIL=YOUR-EMAIL
    restart: unless-stopped
```

The nextcloud service depends on the other three containers. To make Nextcloud’s data persistent while upgrading, and get access to backups, we use a named Docker volume `nextcloud`, similar to the way we used a Docker volume named `db` for the MariaDB data.
Here, we have defined the virtual host, Let’s Encrypt host, and email in the environment variables `VIRTUAL_HOST`, `LETSENCRYPT_HOST`, and `LETSENCRYPT_EMAIL`, respectively. The proxy service creates the subdomain and encrypts it with Let’s Encrypt certificates for the container, given you supply valid domains and emails for those three environment variables.

### Configuring cronjob (optional)

Now this step is optional, but I highly recommend configuring cronjob for large instances.

```
 cron:
   image: rcdailey/nextcloud-cronjob
   container_name: nextcloud-cronjob
   restart: always
   network_mode: none
   depends_on:
   - app
   volumes:
   - /var/run/docker.sock:/var/run/docker.sock:ro
   - /etc/localtime:/etc/localtime:ro
   environment:
   - NEXTCLOUD_CONTAINER_NAME=nextcloud-app
```

At last, we need defined volumes for both Nextcloud and MariaDB for data persistence followed by networks. 

```
volumes:
  nextcloud:
  db:

networks:
  nextcloud_network:
```

After combining all the service definitions, your final docker-compose.yml should look like this:

<details>
  <summary>docker-compose.yml</summary>

```
version: '3'  

services:

  proxy:
    image: jwilder/nginx-proxy:alpine
    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"
    container_name: nextcloud-proxy
    networks:
      - nextcloud_network
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./proxy/conf.d:/etc/nginx/conf.d:rw
      - ./proxy/vhost.d:/etc/nginx/vhost.d:rw
      - ./proxy/html:/usr/share/nginx/html:rw
      - ./proxy/certs:/etc/nginx/certs:ro
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/tmp/docker.sock:ro
    restart: unless-stopped

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: nextcloud-letsencrypt
    depends_on:
      - proxy
    networks:
      - nextcloud_network
    volumes:
      - ./proxy/certs:/etc/nginx/certs:rw
      - ./proxy/vhost.d:/etc/nginx/vhost.d:rw
      - ./proxy/html:/usr/share/nginx/html:rw
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  db:
    image: mariadb
    container_name: nextcloud-mariadb
    command: ['--innodb_read_only_compressed=OFF']
    networks:
      - nextcloud_network
    volumes:
      - db:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    environment:
      - MYSQL_ROOT_PASSWORD=secret
      - MYSQL_PASSWORD=mysql
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    restart: unless-stopped
    
  app:
    image: nextcloud:latest
    container_name: nextcloud-app
    networks:
      - nextcloud_network
    depends_on:
      - letsencrypt
      - proxy
      - db
    volumes:
      - nextcloud:/var/www/html
      - ./app/config:/var/www/html/config
      - ./app/custom_apps:/var/www/html/custom_apps
      - ./app/data:/var/www/html/data
      - ./app/themes:/var/www/html/themes
      - /etc/localtime:/etc/localtime:ro
    environment:
      - VIRTUAL_HOST=nextcloud.DOMAIN_HERE
      - LETSENCRYPT_HOST=nextcloud.DOMAIN_HERE
      - LETSENCRYPT_EMAIL=EMAIL_HERE
    restart: unless-stopped

  cron:
    image: rcdailey/nextcloud-cronjob
    container_name: nextcloud-cronjob
    restart: always
    network_mode: none
    depends_on:
    - app
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - /etc/localtime:/etc/localtime:ro
    environment:
    - NEXTCLOUD_CONTAINER_NAME=nextcloud-app

volumes:
  nextcloud:
  db:

networks:
  nextcloud_network:
```
</details>

### Get it up and running

Now run the `docker-compose` from the terminal to create the containers: 

```
# docker-compose up -d
```

To confirm all the containers are running, issue the following command: 

```
# docker ps -a
```

Wait a minute for the SSL certificate generation process to finish, and then load up the domain name you chose in your browser. Enter your chosen admin username and password. Choose MySQL as the database in the configure database section. Type in the username, password, and database name you configured via the `MYSQL_USER`, `MYSQL_PASSWORD`, and `MYSQL_DATABASE` environment variable from earlier. Change the hostname value from localhost to `db` and click Finish Setup. 

In case you get an error add the follow line under the `container_name: nextcloud-mariadb` in the `db` service:

```
command: ['--innodb_read_only_compressed=OFF']
```

### Post installation

Now after all the files are generated, let's start tweaking some settings.

Under `/proxy/conf.d/` create a file called `custom_proxy.conf` and add the following lines:

```
# Increase PHP timeouts
proxy_read_timeout 3600;
proxy_connect_timeout 3600;
proxy_send_timeout 3600;
send_timeout 3600;
fastcgi_read_timeout 3600;
fastcgi_send_timeout 3600;
fastcgi_connect_timeout 3600;

# set max upload size for mobile
client_max_body_size 0;
```
This will make it so we can upload files larger than the default size (1MB) and fix some timeout errors, especially when using the desktop sync client or an third party sync client.

If you want to use the mobile client, you'll notice that you're stuck in a login loop, to fix that, head over to `/app/config/config.php` and add the following line under `'overwrite.cli.url'`.

```
'overwriteprotocol' => 'https',
```

Restart all the containers and you're done. I also recommend installing `portainer` for easier container management.


Sources: [ssdnodes](https://blog.ssdnodes.com/blog/installing-nextcloud-docker/)